services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: mmpass
      POSTGRES_DB: mattermost
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mmuser -d mattermost"]
      interval: 3s
      timeout: 3s
      retries: 10

  mattermost:
    image: mattermost/mattermost-team-edition:9.11
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: "postgres://mmuser:mmpass@postgres:5432/mattermost?sslmode=disable"
      MM_SERVICESETTINGS_SITEURL: "http://mattermost:8065"
      MM_SERVICESETTINGS_LISTENADDRESS: ":8065"
      MM_SERVICESETTINGS_ENABLEBOTACCOUNTCREATION: "true"
      MM_SERVICESETTINGS_ENABLEUSERACCESSTOKENS: "true"
      MM_TEAMSETTINGS_ENABLEOPENSERVER: "true"
      MM_SERVICESETTINGS_ENABLEPOSTUSERNAMEOVERRIDE: "true"
      MM_SERVICESETTINGS_ENABLEPOSTICONOVERRIDE: "true"
      MM_SERVICESETTINGS_ENABLECUSTOMEMOJI: "true"
      MM_SERVICESETTINGS_ENABLEINCOMINGWEBHOOKS: "true"
      MM_SERVICESETTINGS_ENABLEOUTGOINGWEBHOOKS: "true"
    ports:
      - "18065:8065"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8065/api/v4/system/ping"]
      interval: 5s
      timeout: 5s
      retries: 30

  synapse:
    image: matrixdotorg/synapse:latest
    environment:
      SYNAPSE_SERVER_NAME: "localhost"
      SYNAPSE_REPORT_STATS: "no"
    volumes:
      - ./synapse-data:/data
    ports:
      - "18008:8008"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8008/health"]
      interval: 5s
      timeout: 5s
      retries: 20

  mautrix-mattermost:
    build:
      context: ..
      target: runtime
    depends_on:
      synapse:
        condition: service_healthy
      mattermost:
        condition: service_healthy
    environment:
      MATTERMOST_AUTO_SERVER_URL: "http://mattermost:8065"
      MATTERMOST_AUTO_OWNER_MXID: "@admin:localhost"
      MATTERMOST_AUTO_TOKEN: "${MM_BRIDGE_TOKEN:-}"
      # Per-agent puppet tokens (set by run.sh via .env file)
      MATTERMOST_PUPPET_COO_MXID: "${MATTERMOST_PUPPET_COO_MXID:-}"
      MATTERMOST_PUPPET_COO_TOKEN: "${MATTERMOST_PUPPET_COO_TOKEN:-}"
      MATTERMOST_PUPPET_CTO_MXID: "${MATTERMOST_PUPPET_CTO_MXID:-}"
      MATTERMOST_PUPPET_CTO_TOKEN: "${MATTERMOST_PUPPET_CTO_TOKEN:-}"
    volumes:
      - ./bridge-data:/data
    ports:
      - "29319:29319"
      - "29320:29320"
